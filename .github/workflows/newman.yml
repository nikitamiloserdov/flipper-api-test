name: API tests (Newman)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  newman:
    runs-on: ubuntu-latest

    # üîê –ü—Ä–∞–≤–∞:
    # - contents: write ‚Üí –ø—É—à –≤ gh-pages
    # - checks: write ‚Üí JUnit summary
    permissions:
       checks: write
       contents: write
       pull-requests: read

    steps:
      # üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # üü¢ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js (–Ω—É–∂–µ–Ω –¥–ª—è Newman)
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Newman
      - name: üì¶ Install Newman
        run: npm install -g newman

      # üßæ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML-—Ä–µ–ø–æ—Ä—Ç—ë—Ä
      - name: üßæ Install Newman HTML Reporter
        run: npm install -g newman-reporter-htmlextra

      # üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      # –ü–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ CI "–Ω–µ –≤–∏–¥–∏—Ç" —Ñ–∞–π–ª—ã
      - name: üîç Debug repository structure
        run: |
          echo "Current directory:"
          pwd
          echo "Root files:"
          ls -la
          echo "Postman folder:"
          ls -la postman || true

      # üÜî –®–ê–ì 1 ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ RUN_ID
      # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
      # - –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—É—Å–∫–æ–≤
      # - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ /runs/<RUN_ID>/
      - name: üÜî Generate RUN_ID
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Run ID: $RUN_ID"

      # ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ Postman –∫–æ–ª–ª–µ–∫—Ü–∏–∏
      # ‚ùó –í–ê–ñ–ù–û:
      # continue-on-error: true
      # ‚Üí —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç —É–ø–∞—Å—Ç—å, –Ω–æ job –ù–ï –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
      - name: ‚ñ∂Ô∏è Run Postman collection
        continue-on-error: true
        run: |
          mkdir -p reports
          mkdir -p public/runs/${RUN_ID}

          newman run "postman/Flipper API.postman_collection.json" \
            --timeout-request 60000 \
            --delay-request 200 \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-junit-export reports/newman-report.xml

          # üìÅ –ö–ª–∞–¥—ë–º HTML-–æ—Ç—á—ë—Ç –≤ –ø–∞–ø–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
          cp reports/newman-report.html public/runs/${RUN_ID}/index.html

      # üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á—ë—Ç—ã –∫–∞–∫ artifacts (–¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)
      - name: üì§ Upload Newman reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/

      # üìä –ü—É–±–ª–∏–∫—É–µ–º JUnit —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ GitHub Summary
      # –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      - name: üìä Publish test results (JUnit ‚Üí Summary)
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/newman-report.xml

      # üöÄ –®–ê–ì 2 ‚Äî –î–µ–ø–ª–æ–π HTML-–æ—Ç—á—ë—Ç–æ–≤ –≤ GitHub Pages
      # ‚ùó –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –í–°–ï–ì–î–ê, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      - name: üöÄ Deploy to GitHub Pages
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # üîí –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
          cp -r public /tmp/public

          # üåø –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ gh-pages (–∏–ª–∏ —Å–æ–∑–¥–∞—ë–º —Å –Ω—É–ª—è)
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          # üìÇ –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ runs —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          mkdir -p runs

          # ‚ûï –î–æ–±–∞–≤–ª—è–µ–º –ù–û–í–´–ô –∑–∞–ø—É—Å–∫ (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Å—Ç–∞—Ä—ã–µ)
          cp -r /tmp/public/runs/${RUN_ID} runs/

          # üö´ –û—Ç–∫–ª—é—á–∞–µ–º Jekyll (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
          touch .nojekyll

          git add runs .nojekyll
          git commit -m "deploy: ${RUN_ID}" || echo "Nothing to commit"
          git push origin gh-pages

      # üîó –ü—É–±–ª–∏–∫—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π RUN –≤ Summary
      - name: üîó Publish report link to Summary
        if: always()
        run: |
          echo "## üß™ Newman API Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **HTML Report:**" >> $GITHUB_STEP_SUMMARY
          echo "https://nikitamiloserdov.github.io/flipper-api-test/runs/${RUN_ID}/" >> $GITHUB_STEP_SUMMARY
