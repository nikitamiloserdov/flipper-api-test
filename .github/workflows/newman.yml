name: API tests (Newman)

on:
  workflow_dispatch:

  push:
    branches: [ "main" ]

  pull_request:
    branches: [ "main" ]

  # Cron (UTC)
  # –ú–æ—Å–∫–≤–∞ = UTC+3
  # –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º —Å 22:00 –¥–æ 07:00 –ú–°–ö
  schedule:
    - cron: "*/15 4-18 * * *"   # 07:00‚Äì21:45 –ú–°–ö
    - cron: "*/15 19-21 * * *"  # 21:00‚Äì21:45 –ú–°–ö

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      checks: write
      pull-requests: read

    steps:
      # =========================================================
      # üì• Checkout main
      # =========================================================
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      # üü¢ Node.js
      # =========================================================
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =========================================================
      # üì¶ Newman + HTML reporter
      # =========================================================
      - name: üì¶ Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      # =========================================================
      # üÜî RUN_ID
      # =========================================================
      - name: üÜî Generate RUN_ID
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # =========================================================
      # üè∑Ô∏è RUN_TYPE (Manual / Auto / Night)
      # =========================================================
      - name: üè∑Ô∏è Determine RUN_TYPE
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RUN_TYPE="Manual"
          else
            RUN_TYPE="Auto"
            if [ "${{ github.event_name }}" = "schedule" ]; then
              HOUR_UTC=$(date -u +"%H")
              if [ "$HOUR_UTC" -ge 19 ] || [ "$HOUR_UTC" -lt 4 ]; then
                RUN_TYPE="Night"
              fi
            fi
          fi

          echo "RUN_TYPE=$RUN_TYPE" >> $GITHUB_ENV

      # =========================================================
      # ‚ñ∂Ô∏è Newman run
      # =========================================================
      - name: ‚ñ∂Ô∏è Run Postman collection
        continue-on-error: true
        run: |
          mkdir -p reports
          mkdir -p public/runs/${RUN_ID}

          newman run "postman/Flipper API.postman_collection.json" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/index.html \
            --reporter-junit-export reports/newman-report.xml

          cp reports/index.html public/runs/${RUN_ID}/index.html

      # =========================================================
      # üìÇ Prepare results for TestOps
      # =========================================================
      - name: üìÇ Prepare TestOps results
        if: always()
        run: |
          mkdir -p testops-results
          cp reports/newman-report.xml testops-results/

      # =========================================================
      # üì• Install allurectl
      # =========================================================
      - name: üì• Install allurectl
        if: always()
        run: |
          curl -o allurectl -L https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/allurectl

      # =========================================================
      # üìä Upload to Allure TestOps (–±–µ–∑ —Ç–µ–≥–æ–≤)
      # =========================================================
      - name: üìä Upload results to Allure TestOps
        if: always()
        env:
          TESTOPS_ENDPOINT: ${{ secrets.TESTOPS_ENDPOINT }}
          TESTOPS_TOKEN: ${{ secrets.TESTOPS_TOKEN }}
          TESTOPS_PROJECT_ID: ${{ secrets.TESTOPS_PROJECT_ID }}
        run: |
          export ALLURE_ENDPOINT=${TESTOPS_ENDPOINT}
          export ALLURE_TOKEN=${TESTOPS_TOKEN}

          allurectl upload testops-results \
            --project-id ${TESTOPS_PROJECT_ID} \
            --launch-name "Flipper API ‚Ä¢ ${RUN_TYPE} ‚Ä¢ ${RUN_ID}"

          echo "ALLURE_LAUNCH_URL=${TESTOPS_ENDPOINT}/project/${TESTOPS_PROJECT_ID}/launches" >> $GITHUB_ENV

      # =========================================================
      # üêç Python
      # =========================================================
      - name: üêç Setup Python
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Python deps
        if: always()
        run: pip install requests

      # =========================================================
      # üì© Telegram
      # =========================================================
      - name: üì© Send Telegram report
        if: always()
        env:
          TGBOT: ${{ secrets.TGBOT }}
          CHATID: ${{ secrets.CHATID }}
          RUN_ID: ${{ env.RUN_ID }}
          RUN_TYPE: ${{ env.RUN_TYPE }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ALLURE_LAUNCH_URL: ${{ env.ALLURE_LAUNCH_URL }}
        run: python scripts/send_telegram_report.py

      # =========================================================
      # üöÄ Deploy to GH Pages (–ù–ê –ö–ê–ñ–î–´–ô RUN)
      # =========================================================
      - name: üöÄ Deploy to GitHub Pages
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          cp -r public /tmp/public

          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          mkdir -p runs
          cp -r /tmp/public/runs/${RUN_ID} runs/

          touch .nojekyll

          git add runs .nojekyll
          git commit -m "deploy run ${RUN_ID}" || echo "Nothing to commit"
          git push origin gh-pages
