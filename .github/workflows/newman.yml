name: API tests (Newman)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
       checks: write
       contents: write
       pull-requests: read

    steps:
      # ðŸ“¥ Ð—Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (Postman collection + workflow)
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ðŸŸ¢ ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ Node.js (Ð½ÑƒÐ¶ÐµÐ½ Ð´Ð»Ñ Newman)
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Newman (CLI Ð´Ð»Ñ Postman)
      - name: ðŸ“¦ Install Newman
        run: npm install -g newman

      # ðŸ§¾ HTML-Ñ€ÐµÐ¿Ð¾Ñ€Ñ‚Ñ‘Ñ€ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð±Ñ‹Ð» ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚)
      - name: ðŸ§¾ Install Newman HTML Reporter
        run: npm install -g newman-reporter-htmlextra

      # ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: ðŸ” Debug repository structure
        run: |
          echo "Current directory:"
          pwd
          echo "Root files:"
          ls -la
          echo "Postman folder:"
          ls -la postman || true

      # ðŸ†” Ð¨ÐÐ“ 1 â€” Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ RUN_ID
      - name: ðŸ†” Generate RUN_ID
        id: run_id
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Run ID: $RUN_ID"

      # â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐº Postman ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
      - name: â–¶ï¸ Run Postman collection
        run: |
          mkdir -p reports
          mkdir -p gh-pages/runs/${RUN_ID}

          newman run "postman/Flipper API.postman_collection.json" \
            --timeout-request 60000 \
            --delay-request 200 \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/newman-report.html \
            --reporter-junit-export reports/newman-report.xml

          # ðŸ“ ÐšÐ»Ð°Ð´Ñ‘Ð¼ HTML Ð² Ð¿Ð°Ð¿ÐºÑƒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          cp reports/newman-report.html gh-pages/runs/${RUN_ID}/index.html

      # ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ ÐºÐ°Ðº artifacts (Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ)
      - name: ðŸ“¤ Upload Newman reports
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/

      # ðŸ“Š ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ JUnit Ð² GitHub Summary
      - name: ðŸ“Š Publish test results (JUnit â†’ Summary)
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: reports/newman-report.xml

      # ðŸ“ Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÐŸÐ Ð¯ÐœÐ£Ð® ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð² Summary
      - name: ðŸ”— Publish report link to Summary
        if: always()
        run: |
          echo "## ðŸ§ª Newman API Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **HTML Report:**" >> $GITHUB_STEP_SUMMARY
          echo "https://nikitamiloserdov.github.io/flipper-api-test/runs/${RUN_ID}/" >> $GITHUB_STEP_SUMMARY
