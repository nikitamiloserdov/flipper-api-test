name: API tests (Newman)

on:
  workflow_dispatch:

  push:
    branches: [ "main" ]

  pull_request:
    branches: [ "main" ]

  # Cron (UTC)
  # ÐœÐ¾ÑÐºÐ²Ð° = UTC+3
  # ÐÐ• Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ 22:00 Ð´Ð¾ 07:00 ÐœÐ¡Ðš
  schedule:
    - cron: "*/15 4-18 * * *"   # 07:00â€“21:45 ÐœÐ¡Ðš
    - cron: "*/15 19-21 * * *"  # 21:00â€“21:45 ÐœÐ¡Ðš

jobs:
  newman:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      checks: write
      pull-requests: read

    steps:
      # =========================================================
      # ðŸ“¥ Checkout main
      # =========================================================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      # ðŸŸ¢ Node.js
      # =========================================================
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =========================================================
      # ðŸ“¦ Newman + HTML reporter
      # =========================================================
      - name: ðŸ“¦ Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      # =========================================================
      # ðŸ†” RUN_ID
      # =========================================================
      - name: ðŸ†” Generate RUN_ID
        run: |
          RUN_ID=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # =========================================================
      # ðŸ·ï¸ RUN_TYPE (Manual / Auto / Night)
      # =========================================================
      - name: ðŸ·ï¸ Determine RUN_TYPE
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RUN_TYPE="Manual"
          else
            RUN_TYPE="Auto"
            if [ "${{ github.event_name }}" = "schedule" ]; then
              HOUR_UTC=$(date -u +"%H")
              if [ "$HOUR_UTC" -ge 19 ] || [ "$HOUR_UTC" -lt 4 ]; then
                RUN_TYPE="Night"
              fi
            fi
          fi

          echo "RUN_TYPE=$RUN_TYPE" >> $GITHUB_ENV

      # =========================================================
      # â–¶ï¸ Newman run
      # =========================================================
      - name: â–¶ï¸ Run Postman collection
        continue-on-error: true
        run: |
          mkdir -p reports
          mkdir -p public/runs/${RUN_ID}

          newman run "postman/Flipper API.postman_collection.json" \
            --reporters cli,htmlextra,junit \
            --reporter-htmlextra-export reports/index.html \
            --reporter-junit-export reports/newman-report.xml

          cp reports/index.html public/runs/${RUN_ID}/index.html

      # =========================================================
      # ðŸ“‚ Prepare results for TestOps
      # =========================================================
      - name: ðŸ“‚ Prepare TestOps results
        if: always()
        run: |
          mkdir -p testops-results
          cp reports/newman-report.xml testops-results/

      # =========================================================
      # ðŸ“¥ Install allurectl
      # =========================================================
      - name: ðŸ“¥ Install allurectl
        if: always()
        run: |
          curl -o allurectl -L https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/allurectl

      # =========================================================
      # ðŸ“Š Upload to Allure TestOps (Ð±ÐµÐ· Ñ‚ÐµÐ³Ð¾Ð²)
      # =========================================================
      - name: ðŸ“Š Upload results to Allure TestOps
        if: always()
        env:
          TESTOPS_ENDPOINT: ${{ secrets.TESTOPS_ENDPOINT }}
          TESTOPS_TOKEN: ${{ secrets.TESTOPS_TOKEN }}
          TESTOPS_PROJECT_ID: ${{ secrets.TESTOPS_PROJECT_ID }}
        run: |
          export ALLURE_ENDPOINT=${TESTOPS_ENDPOINT}
          export ALLURE_TOKEN=${TESTOPS_TOKEN}

          allurectl upload testops-results \
            --project-id ${TESTOPS_PROJECT_ID} \
            --launch-name "Flipper API â€¢ ${RUN_TYPE} â€¢ ${RUN_ID}"

          echo "ALLURE_LAUNCH_URL=${TESTOPS_ENDPOINT}/project/${TESTOPS_PROJECT_ID}/launches" >> $GITHUB_ENV

      # =========================================================
      # ðŸ Python
      # =========================================================
      - name: ðŸ Setup Python
        if: always()
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install Python deps
        if: always()
        run: pip install requests

      # =========================================================
      # ðŸ“© Telegram
      # =========================================================
      - name: ðŸ“© Send Telegram report
        if: always()
        env:
          TGBOT: ${{ secrets.TGBOT }}
          CHATID: ${{ secrets.CHATID }}
          RUN_ID: ${{ env.RUN_ID }}
          RUN_TYPE: ${{ env.RUN_TYPE }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ALLURE_LAUNCH_URL: ${{ env.ALLURE_LAUNCH_URL }}
        run: python scripts/send_telegram_report.py

      # =========================================================
      # ðŸš€ Deploy to GH Pages (ÐÐ ÐšÐÐ–Ð”Ð«Ð™ RUN)
      # =========================================================
      - name: ðŸš€ Deploy to GitHub Pages
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          cp -r public /tmp/public

          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          mkdir -p runs
          cp -r /tmp/public/runs/${RUN_ID} runs/

          touch .nojekyll

          git add runs .nojekyll
          git commit -m "deploy run ${RUN_ID}" || echo "Nothing to commit"
          git push origin gh-pages


      # =========================================================
      # ðŸ§¾ Publish workflow summary (ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹, Ð±ÐµÐ· Markdown-ÐºÐ¾ÑÑÐºÐ¾Ð²)
      # =========================================================
      - name: ðŸ§¾ Publish workflow summary
        if: always()
        run: |
          {
            echo "## ðŸ§ª Flipper API â€“ Newman"
            echo ""
            echo "**Ð¢Ð¸Ð¿ Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ð°:** ${RUN_TYPE}"
            echo "**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ${{ job.status }}"
            echo ""
            echo "ðŸ”— **HTML Report:**"
            echo ""
            echo "```"
            echo "https://nikitamiloserdov.github.io/fl-test/runs/${RUN_ID}/"
            echo "```"
          } >> $GITHUB_STEP_SUMMARY



